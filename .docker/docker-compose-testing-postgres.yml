version: '3'
services:
  postgres:
    container_name: postgres
    build:
      context: ../tests/testdata
      dockerfile: Dockerfile-postgis
      args:
        POSTGIS_VER: ${POSTGIS_VER}
    environment:
      POSTGRES_USER: docker
      POSTGRES_PASSWORD: docker
      POSTGRES_DB: docker
      ALLOW_IP_RANGE: "172.18.0.0/16"
# The following files are added in Dockerfile-postgis
      SSL_CERT_FILE: /etc/ssl/certs/postgres.crt
      SSL_KEY_FILE: /etc/ssl/private/postgres.key
      SSL_CA_FILE: /etc/ssl/certs/qgis_ca.crt

  qgis-deps:
    container_name: qgis-deps
    tty: true
    image: qgis/qgis3-build-deps-bin-only:${DOCKER_TAG}
    volumes:
      - ${GH_WORKSPACE}:/root/QGIS
    links:
      - postgres
    env_file:
      - docker-variables.env
    cap_add:
      - NET_ADMIN
